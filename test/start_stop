#!/bin/bash
# safe bash
set -o errexit -o noclobber -o nounset -o pipefail -o xtrace

# тестирование "наработкой на отказ" start --all/stop --all
readonly root_dir="$(dirname "${BASH_SOURCE[0]}")/.."
. "${root_dir}/load_config.bash"

. "${lib_dir}/vm_ssh.bash"
. "${lib_dir}/rollback.bash"
. "${lib_dir}/start_vms.bash"
. "${lib_dir}/soft_off.bash"
. "${lib_dir}/tick.bash"

while true
do
	tick+
	# Если не откатывать, то со временем переполняются винчестеры :)
	rollback 'setup'
	start_vms
	for i in "${!cluster_name[@]}"
	do
		vm_ssh "${vm_name[$i]}" "pcs --debug cluster start --all --wait"
	done;unset i
	for h in "${float_name[@]}"
	do
		echo "Waiting for ping ${h}"
		while ! ping -q -c 1 "$h"
		do
			sleep 5
		done
	done;unset h
	for i in "${!cluster_name[@]}"
	do
		vm_ssh "${vm_name[$i]}" "pcs --debug cluster stop --all --wait"
	done;unset i
	sleep 5
	soft_off
done
